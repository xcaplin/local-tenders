name: Fetch Tender Data

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write

jobs:
  fetch-and-cache:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch tender data from API
        run: |
          # Fetch data from API (without date filter to start)
          # The ocdsRecordPackages endpoint may not support updatedFrom parameter
          API_URL="https://www.find-tender.service.gov.uk/api/1.0/ocdsRecordPackages?stages=tender&limit=100"

          echo "Fetching from: $API_URL"

          # Fetch and save
          HTTP_STATUS=$(curl -s -w "%{http_code}" -o /tmp/api-response.json "$API_URL" \
            -H "Accept: application/json")

          echo "HTTP Status: $HTTP_STATUS"

          # If that fails, try without stages parameter
          if [ "$HTTP_STATUS" -ne 200 ]; then
            echo "âš ï¸ Request with stages parameter failed, trying without it..."
            API_URL="https://www.find-tender.service.gov.uk/api/1.0/ocdsRecordPackages?limit=100"

            HTTP_STATUS=$(curl -s -w "%{http_code}" -o /tmp/api-response.json "$API_URL" \
              -H "Accept: application/json")

            echo "HTTP Status (retry): $HTTP_STATUS"
          fi

          # Check if fetch was successful
          if [ "$HTTP_STATUS" -ne 200 ]; then
            echo "âŒ API returned HTTP $HTTP_STATUS"
            echo "Response body:"
            cat /tmp/api-response.json
            exit 1
          fi

          if [ ! -s /tmp/api-response.json ]; then
            echo "âŒ API response is empty"
            exit 1
          fi

          # Verify records array exists
          HAS_RECORDS=$(cat /tmp/api-response.json | jq 'has("records")')
          if [ "$HAS_RECORDS" != "true" ]; then
            echo "âŒ API response missing 'records' field"
            cat /tmp/api-response.json
            exit 1
          fi

          # Ensure public directory exists
          mkdir -p public

          # Add metadata and ensure records field exists
          cat /tmp/api-response.json | jq --arg date "$(date -u '+%Y-%m-%d %H:%M:%S UTC')" \
            '{
              records: (.records // []),
              lastUpdated: $date,
              cacheAge: "6 hours",
              links: .links
            }' \
            > public/cached-tenders.json

          echo "âœ… Successfully fetched and cached tender data"

          # Show summary
          RECORD_COUNT=$(cat public/cached-tenders.json | jq '.records | length')
          echo "ðŸ“Š Cached $RECORD_COUNT records"

      - name: Commit cached data
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add public/cached-tenders.json

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update cached tender data [skip ci]"
            git push
            echo "âœ… Committed and pushed cached data"
          fi
